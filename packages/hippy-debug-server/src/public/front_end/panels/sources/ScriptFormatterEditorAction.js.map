{"version":3,"file":"ScriptFormatterEditorAction.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/ScriptFormatterEditorAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/* eslint-disable rulesdir/no_underscored_properties */\n\nimport type * as Common from '../../core/common/common.js'; // eslint-disable-line no-unused-vars\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as FormatterModule from '../../models/formatter/formatter.js';\nimport * as Persistence from '../../models/persistence/persistence.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport type {EditorAction, SourcesView} from './SourcesView.js';\nimport {Events, registerEditorAction} from './SourcesView.js';  // eslint-disable-line no-unused-vars\n\nconst UIStrings = {\n  /**\n  *@description Title of the pretty print button in the Sources panel\n  *@example {file name} PH1\n  */\n  prettyPrintS: 'Pretty print {PH1}',\n  /**\n  *@description Text to pretty print a file\n  */\n  prettyPrint: 'Pretty print',\n};\nconst str_ = i18n.i18n.registerUIStrings('panels/sources/ScriptFormatterEditorAction.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nlet scriptFormatterEditorActionInstance: ScriptFormatterEditorAction;\n\nexport class ScriptFormatterEditorAction implements EditorAction {\n  _pathsToFormatOnLoad: Set<string>;\n  _sourcesView!: SourcesView;\n  _button!: UI.Toolbar.ToolbarButton;\n  private constructor() {\n    this._pathsToFormatOnLoad = new Set();\n  }\n\n  static instance(opts: {\n    forceNew: boolean|null,\n  } = {forceNew: null}): ScriptFormatterEditorAction {\n    const {forceNew} = opts;\n    if (!scriptFormatterEditorActionInstance || forceNew) {\n      scriptFormatterEditorActionInstance = new ScriptFormatterEditorAction();\n    }\n\n    return scriptFormatterEditorActionInstance;\n  }\n\n  _editorSelected(event: Common.EventTarget.EventTargetEvent): void {\n    const uiSourceCode = (event.data as Workspace.UISourceCode.UISourceCode);\n    this._updateButton(uiSourceCode);\n\n    if (this._isFormattableScript(uiSourceCode) && this._pathsToFormatOnLoad.has(uiSourceCode.url()) &&\n        !FormatterModule.SourceFormatter.SourceFormatter.instance().hasFormatted(uiSourceCode)) {\n      this._showFormatted(uiSourceCode);\n    }\n  }\n\n  async _editorClosed(event: Common.EventTarget.EventTargetEvent): Promise<void> {\n    const uiSourceCode = (event.data.uiSourceCode as Workspace.UISourceCode.UISourceCode);\n    const wasSelected = (event.data.wasSelected as boolean);\n\n    if (wasSelected) {\n      this._updateButton(null);\n    }\n    const original =\n        await FormatterModule.SourceFormatter.SourceFormatter.instance().discardFormattedUISourceCode(uiSourceCode);\n    if (original) {\n      this._pathsToFormatOnLoad.delete(original.url());\n    }\n  }\n\n  _updateButton(uiSourceCode: Workspace.UISourceCode.UISourceCode|null): void {\n    const isFormattable = this._isFormattableScript(uiSourceCode);\n    this._button.element.classList.toggle('hidden', !isFormattable);\n    if (uiSourceCode) {\n      // We always update the title of the button, even if the {uiSourceCode} is\n      // not formattable, since we use the title (the aria-label actually) as a\n      // signal for the E2E tests that the source code loading is done.\n      this._button.setTitle(i18nString(UIStrings.prettyPrintS, {PH1: uiSourceCode.name()}));\n    }\n  }\n\n  button(sourcesView: SourcesView): UI.Toolbar.ToolbarButton {\n    if (this._button) {\n      return this._button;\n    }\n\n    this._sourcesView = sourcesView;\n    this._sourcesView.addEventListener(Events.EditorSelected, event => {\n      this._editorSelected(event);\n    });\n    this._sourcesView.addEventListener(Events.EditorClosed, event => {\n      this._editorClosed(event);\n    });\n\n    this._button = new UI.Toolbar.ToolbarButton(i18nString(UIStrings.prettyPrint), 'largeicon-pretty-print');\n    this._button.addEventListener(UI.Toolbar.ToolbarButton.Events.Click, this._onFormatScriptButtonClicked, this);\n    this._updateButton(sourcesView.currentUISourceCode());\n\n    return this._button;\n  }\n\n  _isFormattableScript(uiSourceCode: Workspace.UISourceCode.UISourceCode|null): boolean {\n    if (!uiSourceCode) {\n      return false;\n    }\n    if (uiSourceCode.project().canSetFileContent()) {\n      return false;\n    }\n    if (uiSourceCode.project().type() === Workspace.Workspace.projectTypes.Formatter) {\n      return false;\n    }\n    if (Persistence.Persistence.PersistenceImpl.instance().binding(uiSourceCode)) {\n      return false;\n    }\n    if (uiSourceCode.mimeType() === 'application/wasm') {\n      return false;\n    }\n    return uiSourceCode.contentType().hasScripts();\n  }\n\n  isCurrentUISourceCodeFormattable(): boolean {\n    const uiSourceCode = this._sourcesView.currentUISourceCode();\n    return this._isFormattableScript(uiSourceCode);\n  }\n\n  _onFormatScriptButtonClicked(_event: Common.EventTarget.EventTargetEvent): void {\n    this.toggleFormatScriptSource();\n  }\n\n  toggleFormatScriptSource(): void {\n    const uiSourceCode = this._sourcesView.currentUISourceCode();\n    if (!uiSourceCode || !this._isFormattableScript(uiSourceCode)) {\n      return;\n    }\n    this._pathsToFormatOnLoad.add(uiSourceCode.url());\n    this._showFormatted(uiSourceCode);\n  }\n\n  async _showFormatted(uiSourceCode: Workspace.UISourceCode.UISourceCode): Promise<void> {\n    const formatData = await FormatterModule.SourceFormatter.SourceFormatter.instance().format(uiSourceCode);\n    if (uiSourceCode !== this._sourcesView.currentUISourceCode()) {\n      return;\n    }\n    const sourceFrame = this._sourcesView.viewForFile(uiSourceCode);\n    let start: number[]|number[] = [0, 0];\n    if (sourceFrame instanceof SourceFrame.SourceFrame.SourceFrameImpl) {\n      const selection = sourceFrame.selection();\n      start = formatData.mapping.originalToFormatted(selection.startLine, selection.startColumn);\n    }\n    this._sourcesView.showSourceLocation(formatData.formattedSourceCode, start[0], start[1]);\n  }\n}\n\nregisterEditorAction(ScriptFormatterEditorAction.instance);\n"]}