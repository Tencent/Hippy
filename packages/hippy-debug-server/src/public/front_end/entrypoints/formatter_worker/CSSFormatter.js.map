{"version":3,"file":"CSSFormatter.js","sourceRoot":"","sources":["../../../../../../front_end/entrypoints/formatter_worker/CSSFormatter.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2013 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\n/* eslint-disable rulesdir/no_underscored_properties */\n\nimport * as Platform from '../../core/platform/platform.js';\n\nimport type {FormattedContentBuilder} from './FormattedContentBuilder.js'; // eslint-disable-line no-unused-vars\nimport {createTokenizer} from './FormatterWorker.js';\n\nconst cssTrimEnd = (tokenValue: string): string => {\n  // https://drafts.csswg.org/css-syntax/#whitespace\n  const re = /(?:\\r?\\n|[\\t\\f\\r ])+$/g;\n  return tokenValue.replace(re, '');\n};\n\nexport class CSSFormatter {\n  _builder: FormattedContentBuilder;\n  _toOffset!: number;\n  _fromOffset!: number;\n  _lineEndings!: number[];\n  _lastLine: number;\n  _state: {\n    eatWhitespace: (boolean|undefined),\n    seenProperty: (boolean|undefined),\n    inPropertyValue: (boolean|undefined),\n    afterClosingBrace: (boolean|undefined),\n  };\n  constructor(builder: FormattedContentBuilder) {\n    this._builder = builder;\n    this._lastLine = -1;\n    this._state = {\n      eatWhitespace: undefined,\n      seenProperty: undefined,\n      inPropertyValue: undefined,\n      afterClosingBrace: undefined,\n    };\n  }\n\n  format(text: string, lineEndings: number[], fromOffset: number, toOffset: number): void {\n    this._lineEndings = lineEndings;\n    this._fromOffset = fromOffset;\n    this._toOffset = toOffset;\n    this._state = {\n      eatWhitespace: undefined,\n      seenProperty: undefined,\n      inPropertyValue: undefined,\n      afterClosingBrace: undefined,\n    };\n    this._lastLine = -1;\n    const tokenize = createTokenizer('text/css');\n    const oldEnforce = this._builder.setEnforceSpaceBetweenWords(false);\n    tokenize(text.substring(this._fromOffset, this._toOffset), this._tokenCallback.bind(this));\n    this._builder.setEnforceSpaceBetweenWords(oldEnforce);\n  }\n\n  _tokenCallback(token: string, type: string|null, startPosition: number): void {\n    startPosition += this._fromOffset;\n    const startLine = Platform.ArrayUtilities.lowerBound(\n        this._lineEndings, startPosition, Platform.ArrayUtilities.DEFAULT_COMPARATOR);\n    if (startLine !== this._lastLine) {\n      this._state.eatWhitespace = true;\n    }\n    // The css- prefix is optional, as we override that in the tokenizer defined\n    // in CodeMirrorTextEditor.js. In a worker context, we don't use the prefix.\n    if (type && (/^(css-)?property/.test(type) || /^(css-)?variable-2/.test(type)) && !this._state.inPropertyValue) {\n      this._state.seenProperty = true;\n    }\n    this._lastLine = startLine;\n    // https://drafts.csswg.org/css-syntax/#whitespace\n    const isWhitespace = /^(?:\\r?\\n|[\\t\\f\\r ])+$/.test(token);\n    if (isWhitespace) {\n      if (!this._state.eatWhitespace) {\n        this._builder.addSoftSpace();\n      }\n      return;\n    }\n    this._state.eatWhitespace = false;\n    if (token === '\\n') {\n      return;\n    }\n\n    if (token !== '}') {\n      if (this._state.afterClosingBrace) {\n        this._builder.addNewLine(true);\n      }\n      this._state.afterClosingBrace = false;\n    }\n    if (token === '}') {\n      if (this._state.inPropertyValue) {\n        this._builder.addNewLine();\n      }\n      this._builder.decreaseNestingLevel();\n      this._state.afterClosingBrace = true;\n      this._state.inPropertyValue = false;\n    } else if (token === ':' && !this._state.inPropertyValue && this._state.seenProperty) {\n      this._builder.addToken(token, startPosition);\n      this._builder.addSoftSpace();\n      this._state.eatWhitespace = true;\n      this._state.inPropertyValue = true;\n      this._state.seenProperty = false;\n      return;\n    } else if (token === '{') {\n      this._builder.addSoftSpace();\n      this._builder.addToken(token, startPosition);\n      this._builder.addNewLine();\n      this._builder.increaseNestingLevel();\n      return;\n    }\n\n    this._builder.addToken(cssTrimEnd(token), startPosition);\n\n    if (type === 'comment' && !this._state.inPropertyValue && !this._state.seenProperty) {\n      this._builder.addNewLine();\n    }\n    if (token === ';' && this._state.inPropertyValue) {\n      this._state.inPropertyValue = false;\n      this._builder.addNewLine();\n    } else if (token === '}') {\n      this._builder.addNewLine();\n    }\n  }\n}\n"]}