{"version":3,"file":"CSSRuleParser.js","sourceRoot":"","sources":["../../../../../../front_end/entrypoints/formatter_worker/CSSRuleParser.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2016 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/* eslint-disable rulesdir/no_underscored_properties */\n\nimport type {Chunk, ChunkCallback} from './FormatterWorker.js';\nimport {createTokenizer} from './FormatterWorker.js';\n\nexport const CSSParserStates = {\n  Initial: 'Initial',\n  Selector: 'Selector',\n  Style: 'Style',\n  PropertyName: 'PropertyName',\n  PropertyValue: 'PropertyValue',\n  AtRule: 'AtRule',\n};\n\n// TODO(crbug.com/1172300) Ignored during the jsdoc to ts migration\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype Rule = any;\n\ninterface Property {\n  name: string;\n  value: string;\n  range: Range;\n  nameRange: Range;\n  valueRange?: Range;\n}\n\ninterface Range {\n  startLine: number;\n  startColumn: number;\n  endLine: number;\n  endColumn: number;\n}\n\nexport function parseCSS(text: string, chunkCallback: ChunkCallback): void {\n  const chunkSize = 100000;  // characters per data chunk\n  const lines = text.split('\\n');\n  let rules: Rule[] = [];\n  let processedChunkCharacters = 0;\n\n  let state: string = CSSParserStates.Initial;\n  let rule: Rule;\n  let property: Property;\n  const UndefTokenType = new Set();\n\n  let disabledRules: Rule[] = [];\n\n  function disabledRulesCallback(chunk: Chunk): void {\n    disabledRules = disabledRules.concat(chunk.chunk);\n  }\n\n  function cssTrim(tokenValue: string): string {\n    // https://drafts.csswg.org/css-syntax/#whitespace\n    const re = /^(?:\\r?\\n|[\\t\\f\\r ])+|(?:\\r?\\n|[\\t\\f\\r ])+$/g;\n    return tokenValue.replace(re, '');\n  }\n\n  function processToken(tokenValue: string, tokenTypes: string|null, column: number, newColumn: number): void {\n    const tokenType = tokenTypes ? new Set(tokenTypes.split(' ')) : UndefTokenType;\n    switch (state) {\n      case CSSParserStates.Initial:\n        if (tokenType.has('qualifier') || tokenType.has('builtin') || tokenType.has('tag')) {\n          rule = {\n            selectorText: tokenValue,\n            lineNumber: lineNumber,\n            columnNumber: column,\n            properties: [],\n          };\n          state = CSSParserStates.Selector;\n        } else if (tokenType.has('def')) {\n          rule = {\n            atRule: tokenValue,\n            lineNumber: lineNumber,\n            columnNumber: column,\n          };\n          state = CSSParserStates.AtRule;\n        }\n        break;\n      case CSSParserStates.Selector:\n        if (tokenValue === '{' && tokenType === UndefTokenType) {\n          rule.selectorText = cssTrim(rule.selectorText);\n          rule.styleRange = createRange(lineNumber, newColumn);\n          state = CSSParserStates.Style;\n        } else {\n          rule.selectorText += tokenValue;\n        }\n        break;\n      case CSSParserStates.AtRule:\n        if ((tokenValue === ';' || tokenValue === '{') && tokenType === UndefTokenType) {\n          rule.atRule = cssTrim(rule.atRule);\n          rules.push(rule);\n          state = CSSParserStates.Initial;\n        } else {\n          rule.atRule += tokenValue;\n        }\n        break;\n      case CSSParserStates.Style:\n        if (tokenType.has('meta') || tokenType.has('property')) {\n          property = {\n            name: tokenValue,\n            value: '',\n            range: createRange(lineNumber, column),\n            nameRange: createRange(lineNumber, column),\n          };\n          state = CSSParserStates.PropertyName;\n        } else if (tokenValue === '}' && tokenType === UndefTokenType) {\n          rule.styleRange.endLine = lineNumber;\n          rule.styleRange.endColumn = column;\n          rules.push(rule);\n          state = CSSParserStates.Initial;\n        } else if (tokenType.has('comment')) {\n          // The |processToken| is called per-line, so no token spans more than one line.\n          // Support only a one-line comments.\n          if (tokenValue.substring(0, 2) !== '/*' || tokenValue.substring(tokenValue.length - 2) !== '*/') {\n            break;\n          }\n          const uncommentedText = tokenValue.substring(2, tokenValue.length - 2);\n          const fakeRule = 'a{\\n' + uncommentedText + '}';\n          disabledRules = [];\n          parseCSS(fakeRule, disabledRulesCallback);\n          if (disabledRules.length === 1 && disabledRules[0].properties.length === 1) {\n            const disabledProperty = disabledRules[0].properties[0];\n            disabledProperty.disabled = true;\n            disabledProperty.range = createRange(lineNumber, column);\n            disabledProperty.range.endColumn = newColumn;\n            const lineOffset = lineNumber - 1;\n            const columnOffset = column + 2;\n            disabledProperty.nameRange.startLine += lineOffset;\n            disabledProperty.nameRange.startColumn += columnOffset;\n            disabledProperty.nameRange.endLine += lineOffset;\n            disabledProperty.nameRange.endColumn += columnOffset;\n            disabledProperty.valueRange.startLine += lineOffset;\n            disabledProperty.valueRange.startColumn += columnOffset;\n            disabledProperty.valueRange.endLine += lineOffset;\n            disabledProperty.valueRange.endColumn += columnOffset;\n            rule.properties.push(disabledProperty);\n          }\n        }\n        break;\n      case CSSParserStates.PropertyName:\n        if (tokenValue === ':' && tokenType === UndefTokenType) {\n          property.name = property.name;\n          property.nameRange.endLine = lineNumber;\n          property.nameRange.endColumn = column;\n          property.valueRange = createRange(lineNumber, newColumn);\n          state = CSSParserStates.PropertyValue;\n        } else if (tokenType.has('property')) {\n          property.name += tokenValue;\n        }\n        break;\n      case CSSParserStates.PropertyValue:\n        if ((tokenValue === ';' || tokenValue === '}') && tokenType === UndefTokenType) {\n          property.value = property.value;\n          // TODO(crbug.com/1172300) Ignored during the jsdoc to ts migration\n          // @ts-expect-error\n          property.valueRange.endLine = lineNumber;\n          // TODO(crbug.com/1172300) Ignored during the jsdoc to ts migration\n          // @ts-expect-error\n          property.valueRange.endColumn = column;\n          property.range.endLine = lineNumber;\n          property.range.endColumn = tokenValue === ';' ? newColumn : column;\n          rule.properties.push(property);\n          if (tokenValue === '}') {\n            rule.styleRange.endLine = lineNumber;\n            rule.styleRange.endColumn = column;\n            rules.push(rule);\n            state = CSSParserStates.Initial;\n          } else {\n            state = CSSParserStates.Style;\n          }\n        } else if (!tokenType.has('comment')) {\n          property.value += tokenValue;\n        }\n        break;\n      default:\n        console.assert(false, 'Unknown CSS parser state.');\n    }\n    processedChunkCharacters += newColumn - column;\n    if (processedChunkCharacters > chunkSize) {\n      chunkCallback({chunk: rules, isLastChunk: false});\n      rules = [];\n      processedChunkCharacters = 0;\n    }\n  }\n  const tokenizer = createTokenizer('text/css');\n  let lineNumber: number;\n  for (lineNumber = 0; lineNumber < lines.length; ++lineNumber) {\n    const line = lines[lineNumber];\n    tokenizer(line, processToken);\n    processToken('\\n', null, line.length, line.length + 1);\n  }\n  chunkCallback({chunk: rules, isLastChunk: true});\n\n  function createRange(lineNumber: number, columnNumber: number): Range {\n    return {startLine: lineNumber, startColumn: columnNumber, endLine: lineNumber, endColumn: columnNumber};\n  }\n}\n"]}