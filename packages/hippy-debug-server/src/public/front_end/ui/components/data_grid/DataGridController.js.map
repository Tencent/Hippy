{"version":3,"file":"DataGridController.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/data_grid/DataGridController.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as LitHtml from '../../../ui/lit-html/lit-html.js';\nimport * as ComponentHelpers from '../helpers/helpers.js';\nimport type * as TextUtils from '../../../models/text_utils/text_utils.js';\nimport type {SortState, Column, Row, ContextMenuColumnSortClickEvent} from './DataGridUtils.js';\nimport {SortDirection, getRowEntryForColumnId} from './DataGridUtils.js';\nimport type {DataGridData, ColumnHeaderClickEvent, DataGridContextMenusConfiguration} from './DataGrid.js';\nimport {DataGrid} from './DataGrid.js';\n\nexport interface DataGridControllerData {\n  columns: Column[];\n  rows: Row[];\n  filters?: readonly TextUtils.TextUtils.ParsedFilter[];\n  /**\n   * Sets an initial sort state for the data grid. Is only used if the component\n   * hasn't rendered yet. If you pass this in on subsequent renders, it is\n   * ignored.\n   */\n  initialSort?: SortState;\n  contextMenus?: DataGridContextMenusConfiguration;\n}\n\nexport class DataGridController extends HTMLElement {\n  static litTagName = LitHtml.literal`devtools-data-grid-controller`;\n  private readonly shadow = this.attachShadow({mode: 'open'});\n\n  private hasRenderedAtLeastOnce = false;\n  private columns: readonly Column[] = [];\n  private rows: Row[] = [];\n  private contextMenus?: DataGridContextMenusConfiguration = undefined;\n\n  /**\n   * Because the controller will sort data in place (e.g. mutate it) when we get\n   * new data in we store the original data separately. This is so we don't\n   * mutate the data we're given, but a copy of the data. If our `get data` is\n   * called, we'll return the original, not the sorted data.\n   */\n  private originalColumns: readonly Column[] = [];\n  private originalRows: Row[] = [];\n\n  private sortState: Readonly<SortState>|null = null;\n  private filters: readonly TextUtils.TextUtils.ParsedFilter[] = [];\n\n  get data(): DataGridControllerData {\n    return {\n      columns: this.originalColumns as Column[],\n      rows: this.originalRows as Row[],\n      filters: this.filters,\n      contextMenus: this.contextMenus,\n    };\n  }\n\n  set data(data: DataGridControllerData) {\n    this.originalColumns = data.columns;\n    this.originalRows = data.rows;\n    this.contextMenus = data.contextMenus;\n    this.filters = data.filters || [];\n    this.contextMenus = data.contextMenus;\n\n    this.columns = [...this.originalColumns];\n    this.rows = this.cloneAndFilterRows(data.rows, this.filters);\n\n    if (!this.hasRenderedAtLeastOnce && data.initialSort) {\n      this.sortState = data.initialSort;\n    }\n\n    if (this.sortState) {\n      this.sortRows(this.sortState);\n    }\n\n    this.render();\n  }\n\n  private testRowWithFilter(row: Row, filter: TextUtils.TextUtils.ParsedFilter): boolean {\n    let rowMatchesFilter = false;\n\n    const {key, text, negative, regex} = filter;\n\n    let dataToTest;\n    if (key) {\n      const cell = getRowEntryForColumnId(row, key);\n      dataToTest = JSON.stringify(cell.value).toLowerCase();\n    } else {\n      dataToTest = JSON.stringify(row.cells.map(cell => cell.value)).toLowerCase();\n    }\n\n    if (regex) {\n      rowMatchesFilter = regex.test(dataToTest);\n    } else if (text) {\n      rowMatchesFilter = dataToTest.includes(text.toLowerCase());\n    }\n\n    // If `negative` is set to `true`, that means we have to flip the final\n    // result, because the filter is matching anything that doesn't match. e.g.\n    // {text: 'foo', negative: false} matches rows that contain the text `foo`\n    // but {text: 'foo', negative: true} matches rows that do NOT contain the\n    // text `foo` so if a filter is marked as negative, we first match against\n    // that filter, and then we flip it here.\n    return negative ? !rowMatchesFilter : rowMatchesFilter;\n  }\n\n  private cloneAndFilterRows(rows: Row[], filters: readonly TextUtils.TextUtils.ParsedFilter[]): Row[] {\n    if (filters.length === 0) {\n      return [...rows];\n    }\n\n    return rows.map(row => {\n      // We assume that the row should be visible by default.\n      let rowShouldBeVisible = true;\n      for (const filter of filters) {\n        const rowMatchesFilter = this.testRowWithFilter(row, filter);\n        // If there are multiple filters, if any return false we hide the row.\n        // So if we get a false from testRowWithFilter, we can break early and return false.\n        if (!rowMatchesFilter) {\n          rowShouldBeVisible = false;\n          break;\n        }\n      }\n      return {\n        ...row,\n        hidden: !rowShouldBeVisible,\n      };\n    });\n  }\n\n  private sortRows(state: SortState): void {\n    const {columnId, direction} = state;\n\n    this.rows.sort((row1, row2) => {\n      const cell1 = getRowEntryForColumnId(row1, columnId);\n      const cell2 = getRowEntryForColumnId(row2, columnId);\n\n      const value1 = typeof cell1.value === 'number' ? cell1.value : String(cell1.value).toUpperCase();\n      const value2 = typeof cell2.value === 'number' ? cell2.value : String(cell2.value).toUpperCase();\n      if (value1 < value2) {\n        return direction === SortDirection.ASC ? -1 : 1;\n      }\n      if (value1 > value2) {\n        return direction === SortDirection.ASC ? 1 : -1;\n      }\n      return 0;\n    });\n    this.render();\n  }\n\n  private onColumnHeaderClick(event: ColumnHeaderClickEvent): void {\n    const {column} = event.data;\n    this.applySortOnColumn(column);\n  }\n\n  private applySortOnColumn(column: Column): void {\n    if (this.sortState && this.sortState.columnId === column.id) {\n      const {columnId, direction} = this.sortState;\n\n      /* When users sort, we go No Sort => ASC => DESC => No sort\n       * So if the current direction is DESC, we clear the state.\n       */\n      if (direction === SortDirection.DESC) {\n        this.sortState = null;\n      } else {\n        /* The state is ASC, so toggle to DESC */\n        this.sortState = {\n          columnId,\n          direction: SortDirection.DESC,\n        };\n      }\n    } else {\n      /* The column wasn't previously sorted, so we sort it in ASC order. */\n      this.sortState = {\n        columnId: column.id,\n        direction: SortDirection.ASC,\n      };\n    }\n\n    if (this.sortState) {\n      this.sortRows(this.sortState);\n    } else {\n      // No sortstate = render the original rows.\n      this.rows = [...this.originalRows];\n      this.render();\n    }\n  }\n\n  private onContextMenuColumnSortClick(event: ContextMenuColumnSortClickEvent): void {\n    this.applySortOnColumn(event.data.column);\n  }\n\n  private onContextMenuHeaderResetClick(): void {\n    this.sortState = null;\n    this.rows = [...this.originalRows];\n    this.render();\n  }\n\n  private render(): void {\n    // Disabled until https://crbug.com/1079231 is fixed.\n    // clang-format off\n    LitHtml.render(LitHtml.html`\n      <style>\n        :host {\n          display: block;\n          height: 100%;\n          overflow: hidden;\n        }\n      </style>\n      <${DataGrid.litTagName} .data=${{\n          columns: this.columns,\n          rows: this.rows,\n          activeSort: this.sortState,\n          contextMenus: this.contextMenus,\n        } as DataGridData}\n        @columnheaderclick=${this.onColumnHeaderClick}\n        @contextmenucolumnsortclick=${this.onContextMenuColumnSortClick}\n        @contextmenuheaderresetclick=${this.onContextMenuHeaderResetClick}\n     ></${DataGrid.litTagName}>\n    `, this.shadow, {\n      host: this,\n    });\n    // clang-format on\n    this.hasRenderedAtLeastOnce = true;\n  }\n}\n\nComponentHelpers.CustomElements.defineComponent('devtools-data-grid-controller', DataGridController);\n\ndeclare global {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  interface HTMLElementTagNameMap {\n    'devtools-data-grid-controller': DataGridController;\n  }\n}\n"]}