{"version":3,"file":"RecordingEventHandler.js","sourceRoot":"","sources":["../../../../../../front_end/models/recorder/RecordingEventHandler.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\n\nimport type {RecordingSession} from './RecordingSession.js';\nimport {hasCondition, hasFrameContext} from './Steps.js';\nimport type {Condition, FrameContext, Step} from './Steps.js';\n\nexport class RecordingEventHandler {\n  private target: SDK.Target.Target;\n  private session: RecordingSession;\n  private resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel;\n  private lastStep: Step|null;\n  private lastStepTimeout: number|null;\n\n  constructor(session: RecordingSession, target: SDK.Target.Target) {\n    this.target = target;\n    this.session = session;\n    this.lastStep = null;\n    this.lastStepTimeout = null;\n\n    const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!resourceTreeModel) {\n      throw new Error('ResourceTreeModel instance is missing for the target: ' + target.id());\n    }\n    this.resourceTreeModel = resourceTreeModel;\n  }\n\n  getTarget(): string {\n    return this.target.id() === 'main' ? 'main' : this.target.inspectedURL();\n  }\n\n  getContextForFrame(frame: SDK.ResourceTreeModel.ResourceTreeFrame): FrameContext {\n    const path = [];\n    let currentFrame: SDK.ResourceTreeModel.ResourceTreeFrame = frame;\n    while (currentFrame) {\n      const parentFrame = currentFrame.parentFrame();\n      if (!parentFrame) {\n        break;\n      }\n\n      const childFrames = parentFrame.childFrames;\n      const index = childFrames.indexOf(currentFrame);\n      path.unshift(index);\n      currentFrame = parentFrame;\n    }\n\n    const target = this.getTarget();\n    return {\n      target,\n      path,\n    };\n  }\n\n  bindingCalled(frameId: string, step: Step): void {\n    const frame = this.resourceTreeModel.frameForId(frameId);\n    if (!frame) {\n      throw new Error('Could not find frame.');\n    }\n\n    const context = this.getContextForFrame(frame);\n\n    if (hasFrameContext(step)) {\n      this.appendStep({...step, context});\n    } else {\n      this.appendStep(step);\n    }\n  }\n\n  async appendStep(step: Step): Promise<void> {\n    this.lastStep = await this.session.appendStep(step);\n    if (this.lastStepTimeout) {\n      window.clearTimeout(this.lastStepTimeout);\n    }\n    this.lastStepTimeout = window.setTimeout(() => {\n      this.lastStep = null;\n      this.lastStepTimeout = null;\n    }, 1000);\n  }\n\n  addConditionToLastStep(condition: Condition): void {\n    if (!this.lastStep) {\n      return;\n    }\n\n    if (hasCondition(this.lastStep)) {\n      this.session.addConditionToStep(this.lastStep, condition);\n    }\n  }\n\n  targetDestroyed(): void {\n    // TODO: figure out how this works with sections\n    // this.appendStep(new CloseStep(this.getTarget()));\n  }\n\n  targetInfoChanged(url: string): void {\n    this.addConditionToLastStep({\n      type: 'waitForNavigation',\n      expectedUrl: url,\n    });\n  }\n}\n"]}