{"version":3,"file":"RecordingClient.js","sourceRoot":"","sources":["../../../../../../front_end/models/recorder/RecordingClient.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nexport type Step = {\n  type: 'click',\n  selector: string,\n}|{\n  type: 'submit',\n  selector: string,\n}|{\n  type: 'change',\n  selector: string,\n  value: string,\n}|{\n  type: 'keydown',\n  altKey: boolean,\n  ctrlKey: boolean,\n  key: string,\n  metaKey: boolean,\n  shiftKey: boolean,\n}|{\n  type: 'keyup',\n  altKey: boolean,\n  ctrlKey: boolean,\n  key: string,\n  metaKey: boolean,\n  shiftKey: boolean,\n};\n\ndeclare global {\n  interface HTMLElement {\n    role: string;\n    ariaLabel: string|null;\n  }\n\n  interface SubmitEvent extends Event {\n    submitter: HTMLElement;\n  }\n\n  interface HTMLElementEventMap {\n    'submit': SubmitEvent;\n  }\n\n  interface Window {\n    _recorderEventListener?: (event: Event) => void;\n    addStep(step: string): void;\n  }\n}\n\nexport interface Exports {\n  createStepFromEvent?: (event: Event, target: EventTarget|null, isTrusted: boolean) => Step | undefined;\n  getSelector?: (node: Node) => string;\n  teardown?: () => void;\n}\n\n/**\n * This function is special because it gets injected into the target page.\n * All runtime code should be defined withing the function so that it can\n * be serialised.\n */\nexport function setupRecordingClient(\n    bindings: {\n      getAccessibleName: (node: Node) => string,\n      getAccessibleRole: (node: Node) => string,\n    },\n    debug = false, allowUntrustedEvents = false, exports: Exports = {}): void {\n  const log = (...args: unknown[]): void => {\n    if (debug) {\n      console.log(...args);  // eslint-disable-line no-console\n    }\n  };\n\n  const createStepFromEvent = (event: Event, target: EventTarget|null, isTrusted = false): Step|undefined => {\n    // Clicking on a submit button will emit a submit event\n    // which will be handled in a different handler.\n    // TODO: figure out the event type for Submit.\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    if (event.type === 'submit' && Boolean((event as SubmitEvent).submitter)) {\n      return;\n    }\n    if (!target || (!isTrusted && !allowUntrustedEvents)) {\n      return;\n    }\n    const nodeTarget = target as Node;\n    if (event.type === 'click') {\n      return {\n        type: event.type,\n        selector: getSelector(nodeTarget),\n      };\n    }\n    if (event.type === 'submit') {\n      return {\n        type: event.type,\n        selector: getSelector(nodeTarget),\n      };\n    }\n    if (event.type === 'change') {\n      // Currently we support a Change event only for the select element.\n      // Perhaps eventually we need to create a select-change event to\n      // capture select-specific logic.\n      if (nodeTarget.nodeName.toLowerCase() !== 'select') {\n        return;\n      }\n      return {type: event.type, selector: getSelector(nodeTarget), value: (target as HTMLInputElement).value};\n    }\n    if (event.type === 'keydown' || event.type === 'keyup') {\n      const keyboardEvent = event as KeyboardEvent;\n      return {\n        type: event.type,\n        altKey: keyboardEvent.altKey,\n        ctrlKey: keyboardEvent.ctrlKey,\n        key: keyboardEvent.key,\n        metaKey: keyboardEvent.metaKey,\n        shiftKey: keyboardEvent.shiftKey,\n      };\n    }\n    return;\n  };\n  exports.createStepFromEvent = createStepFromEvent;\n\n  let lastStep: Step|undefined;\n  const recorderEventListener = (event: Event): void => {\n    const target = event.target as HTMLButtonElement;\n    log(target.nodeName, target.type);\n    const step = createStepFromEvent(event, event.target, event.isTrusted);\n    if (!step) {\n      return;\n    }\n    // If you click on a select option both the change event and click event fire.\n    // Therefore, we ignore the click.\n    if (lastStep && step.type === 'click' && lastStep.type === 'change' && step.selector === lastStep.selector) {\n      return;\n    }\n    window.addStep(JSON.stringify(step));\n    lastStep = step;\n  };\n\n  if (!window._recorderEventListener) {\n    log('Setting _recorderEventListener');\n    window.addEventListener('click', recorderEventListener, true);\n    window.addEventListener('submit', recorderEventListener, true);\n    window.addEventListener('change', recorderEventListener, true);\n    window.addEventListener('keydown', recorderEventListener, true);\n    window.addEventListener('keyup', recorderEventListener, true);\n    window._recorderEventListener = recorderEventListener;\n  } else {\n    log('_recorderEventListener was already installed');\n  }\n\n  const teardown = (): void => {\n    window.removeEventListener('click', recorderEventListener, true);\n    window.removeEventListener('submit', recorderEventListener, true);\n    window.removeEventListener('change', recorderEventListener, true);\n    window.removeEventListener('keydown', recorderEventListener, true);\n    window.removeEventListener('keyup', recorderEventListener, true);\n    delete window._recorderEventListener;\n  };\n  exports.teardown = teardown;\n\n  const RELEVANT_ROLES_FOR_ARIA_SELECTORS = new Set(['button', 'link', 'textbox', 'checkbox', 'combobox', 'option']);\n\n  const getSelector = (node: Node): string => {\n    let axNode: Node|null = node;\n    while (axNode) {\n      const role = bindings.getAccessibleRole(axNode);\n      const name = bindings.getAccessibleName(axNode);\n      log('Getting a11y role and name for a node', role, name, axNode);\n      if (name && RELEVANT_ROLES_FOR_ARIA_SELECTORS.has(role)) {\n        return `aria/${name}`;\n      }\n      axNode = axNode.parentNode;\n    }\n    return cssPath(node);\n  };\n  exports.getSelector = getSelector;\n\n  const nodeNameInCorrectCase = (node: Node): string => {\n    // If there is no local name, it's case sensitive\n    if (!('localName' in node)) {\n      return node.nodeName;\n    }\n\n    const element = node as Element;\n\n    // If the names are different lengths, there is a prefix and it's case sensitive\n    if (element.localName.length !== element.nodeName.length) {\n      return element.nodeName;\n    }\n\n    // Return the localname, which will be case insensitive if its an html node\n    return element.localName;\n  };\n\n  const cssPathStep = function(node: Node, optimized: boolean, isTargetNode: boolean): PathStep|null {\n    if (!(node instanceof Element)) {\n      return null;\n    }\n\n    const id = node.id;\n    if (optimized) {\n      if (id) {\n        return new PathStep(idSelector(id), true);\n      }\n      const nodeNameLower = node.nodeName.toLowerCase();\n      if (nodeNameLower === 'body' || nodeNameLower === 'head' || nodeNameLower === 'html') {\n        return new PathStep(nodeNameInCorrectCase(node), true);\n      }\n    }\n    const nodeName = nodeNameInCorrectCase(node);\n\n    if (id) {\n      return new PathStep(nodeName + idSelector(id), true);\n    }\n    const parent = node.parentNode;\n    if (!parent) {\n      return new PathStep(nodeName, true);\n    }\n\n    function prefixedElementClassNames(node: Element): string[] {\n      const classAttribute = node.getAttribute('class');\n      if (!classAttribute) {\n        return [];\n      }\n\n      return classAttribute.split(/\\s+/g).filter(Boolean).map(function(name) {\n        // The prefix is required to store \"__proto__\" in a object-based map.\n        return '$' + name;\n      });\n    }\n\n    function idSelector(id: string): string {\n      return '#' + CSS.escape(id);\n    }\n\n    const prefixedOwnClassNamesArray = prefixedElementClassNames(node);\n    let needsClassNames = false;\n    let needsNthChild = false;\n    let ownIndex = -1;\n    let elementIndex = -1;\n    const siblings = parent.children;\n    for (let i = 0; siblings && (ownIndex === -1 || !needsNthChild) && i < siblings.length; ++i) {\n      const sibling = siblings[i];\n      elementIndex += 1;\n      if (sibling === node) {\n        ownIndex = elementIndex;\n        continue;\n      }\n      if (needsNthChild) {\n        continue;\n      }\n      if (nodeNameInCorrectCase(sibling) !== nodeName) {\n        continue;\n      }\n\n      needsClassNames = true;\n      const ownClassNames = new Set<string>(prefixedOwnClassNamesArray);\n      if (!ownClassNames.size) {\n        needsNthChild = true;\n        continue;\n      }\n      const siblingClassNamesArray = prefixedElementClassNames(sibling);\n      for (let j = 0; j < siblingClassNamesArray.length; ++j) {\n        const siblingClass = siblingClassNamesArray[j];\n        if (!ownClassNames.has(siblingClass)) {\n          continue;\n        }\n        ownClassNames.delete(siblingClass);\n        if (!ownClassNames.size) {\n          needsNthChild = true;\n          break;\n        }\n      }\n    }\n\n    let result = nodeName;\n    if (isTargetNode && nodeName.toLowerCase() === 'input' && node.getAttribute('type') && !node.getAttribute('id') &&\n        !node.getAttribute('class')) {\n      result += '[type=' + CSS.escape((node.getAttribute('type')) || '') + ']';\n    }\n    if (needsNthChild) {\n      result += ':nth-child(' + (ownIndex + 1) + ')';\n    } else if (needsClassNames) {\n      for (const prefixedName of prefixedOwnClassNamesArray) {\n        result += '.' + CSS.escape(prefixedName.slice(1));\n      }\n    }\n\n    return new PathStep(result, false);\n  };\n\n  const cssPath = function(node: Node|null, optimized?: boolean): string {\n    const steps = [];\n    let contextNode: Node|null = node;\n    while (contextNode) {\n      const step = cssPathStep(contextNode, Boolean(optimized), contextNode === node);\n      if (!step) {\n        break;\n      }  // Error - bail out early.\n      steps.push(step);\n      if (step.optimized) {\n        break;\n      }\n      contextNode = contextNode.parentNode;\n    }\n\n    steps.reverse();\n    return steps.join(' > ');\n  };\n\n  class PathStep {\n    value: string;\n    optimized: boolean;\n    constructor(value: string, optimized: boolean) {\n      this.value = value;\n      this.optimized = optimized || false;\n    }\n\n    toString(): string {\n      return this.value;\n    }\n  }\n}\n"]}