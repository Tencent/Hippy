{"version":3,"file":"RecordingPlayer.js","sourceRoot":"","sources":["../../../../../../front_end/models/recorder/RecordingPlayer.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as puppeteer from '../../third_party/puppeteer/puppeteer.js';\nimport {getPuppeteerConnection as getPuppeteerConnectionToCurrentPage} from './PuppeteerConnection.js';\n\nimport type {Step, UserFlow} from './Steps.js';\nimport {assertAllStepTypesAreHandled} from './Steps.js';\n\nexport class RecordingPlayer {\n  userFlow: UserFlow;\n\n  constructor(userFlow: UserFlow) {\n    this.userFlow = userFlow;\n  }\n\n  async play(): Promise<void> {\n    await SDK.TargetManager.TargetManager.instance().suspendAllTargets();\n\n    const {page, browser} = await getPuppeteerConnectionToCurrentPage();\n    if (!page) {\n      throw new Error('could not find main page!');\n    }\n\n    try {\n      page.setDefaultTimeout(5000);\n      let isFirstSection = true;\n\n      for (const section of this.userFlow.sections) {\n        if (isFirstSection) {\n          await page.goto(section.url);\n          isFirstSection = false;\n        }\n\n        for (const step of section.steps) {\n          await this.step(browser, page, step);\n        }\n      }\n    } catch (err) {\n      console.error('ERROR', err.message);\n    } finally {\n      const pages = await browser.pages();\n      for (const page of pages) {\n        // @ts-ignore\n        const client = page._client;\n        await client.send('Network.disable');\n        await client.send('Page.disable');\n        await client.send('Log.disable');\n        await client.send('Performance.disable');\n        await client.send('Runtime.disable');\n      }\n      browser.disconnect();\n      await SDK.TargetManager.TargetManager.instance().resumeAllTargets();\n    }\n  }\n\n  async getTargetPage(browser: puppeteer.Browser, page: puppeteer.Page, step: Step): Promise<puppeteer.Page> {\n    if (!('context' in step) || step.context.target === 'main') {\n      return page;\n    }\n\n    const target = await browser.waitForTarget(t => t.url() === step.context.target);\n    const targetPage = await target.page();\n\n    if (!targetPage) {\n      throw new Error('Could not find target page.');\n    }\n    return targetPage;\n  }\n\n  async getTargetPageAndFrame(browser: puppeteer.Browser, page: puppeteer.Page, step: Step):\n      Promise<{targetPage: puppeteer.Page, frame: puppeteer.Frame}> {\n    const targetPage = await this.getTargetPage(browser, page, step);\n    let frame = targetPage.mainFrame();\n    if ('context' in step) {\n      for (const index of step.context.path) {\n        frame = frame.childFrames()[index];\n      }\n    }\n    return {targetPage, frame};\n  }\n\n  async step(browser: puppeteer.Browser, page: puppeteer.Page, step: Step): Promise<void> {\n    const {targetPage, frame} = await this.getTargetPageAndFrame(browser, page, step);\n\n    let condition: Promise<unknown>|null = null;\n\n    if ('condition' in step && step.condition && step.condition.type === 'waitForNavigation') {\n      condition = targetPage.waitForNavigation();\n    }\n\n    switch (step.type) {\n      case 'click': {\n        const element = await frame.waitForSelector(step.selector);\n        if (!element) {\n          throw new Error('Could not find element: ' + step.selector);\n        }\n        await element.click();\n      } break;\n      case 'submit': {\n        const element = await frame.waitForSelector(step.selector);\n        if (!element) {\n          throw new Error('Could not find element: ' + step.selector);\n        }\n        await element.evaluate(form => (form as HTMLFormElement).submit());\n      } break;\n      case 'emulateNetworkConditions': {\n        await page.emulateNetworkConditions(step.conditions);\n      } break;\n      case 'keydown': {\n        await page.keyboard.down(step.key);\n        await page.waitForTimeout(100);\n      } break;\n      case 'keyup': {\n        await page.keyboard.up(step.key);\n        await page.waitForTimeout(100);\n      } break;\n      case 'close': {\n        await page.close();\n      } break;\n      case 'change': {\n        // TODO(alexrudenko): currently the change event is only supported for <select>s.\n        const element = await frame.waitForSelector(step.selector);\n        if (!element) {\n          throw new Error('Could not find element: ' + step.selector);\n        }\n        await element.select(step.value);\n        // We need blur and focus to make the select dropdown to close.\n        // Otherwise, it remains open until a blur event. This is not very\n        // nice because user actions don't actually generate those events.\n        await element.evaluate(e => e.blur());\n        await element.focus();\n      } break;\n      case 'viewport': {\n        await targetPage.setViewport({\n          width: step.width,\n          height: step.height,\n        });\n        break;\n      }\n      default:\n        assertAllStepTypesAreHandled(step);\n    }\n\n    await condition;\n  }\n}\n"]}